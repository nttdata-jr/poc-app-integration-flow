name: Analysis, build, pack and upload artifact.
on:
    workflow_dispatch:
        inputs:
            repository_name:
                description: 'Nombre del repositorio a procesar'
                required: true
                type: string
            branch_name:
                description: 'Rama del repositorio a procesar'
                required: true
                type: string
            environment:
                description: 'Entorno de despliegue'
                required: true
            port_run_id:
                description: 'ID de la ejecucion en Port'
                required: false
                type: string
            port_context:
                description: 'Contexto proporcionado por Port'
                required: false
                type: string
jobs:
    building-artifact:
        runs-on: ubuntu-latest
        steps:
            - name: Dinamic checkout code
              uses: actions/checkout@v4.2.2
              with:
                repository: ${{ github.repository_owner }}/${{ github.event.inputs.repository_name }}
                ref: ${{ github.event.inputs.branch_name }}
                token: ${{ secrets.REPO_ACCESS_TOKEN }}
                fetch-depth: 0
            - name: Set Up JDK 17
              run: echo "Setting JDK 17"
            - name: Cache Sonar
              run: echo "Caching sonar"
            - name: Sending to SonarQube Scan
              run: echo "Sending project to Sonar"
            - name: Build and Pack
              run: echo "Building and packing artifact"
            - name: Sending to Nexus
              run: echo "Uploading artifact"
            - name: Report status to Port
              uses: port-labs/port-github-action@v1.7.2
              with:
                clientId: ${{ secrets.PORT_CLIENT_ID }}
                clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
                baseUrl: https://api.getport.io
                operation: UPSERT_ENTITY
                identifier: ${{ github.event.inputs.repository_name }}
                blueprint: ${{ github.event.inputs.port_context.blueprint_id }}
                properties: |
                  {
                    "last_build_status": "SUCCESS",
                    "last_build_date": "{{ env.BUILD_DATE }}",
                    "sonar_quality_gate_status": "PASSED"
                  }
                runId: ${{ github.event.inputs.port_run_id }}
                status: "SUCCESS"
                log: |
                  {
                    "message": "Build and upload artifact completed successfully.",
                    "repository": "${{ github.event.inputs.repository_name }}",
                    "branch": "${{ github.event.inputs.branch_name }}",
                    "environment": "${{ github.event.inputs.environment }}"
                  }
